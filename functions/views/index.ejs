<% layout('boilerplate') %>
<% stylesheet('https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css') -%>
<script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>

<div class="nav-wrapper light-green lighten-5">
    <div class="row">

        <div class="col s3" style="margin-top: 10px;">
            <a href="/">
                <img src="/img/logo.png" alt="Apna Kisan" width="45px" height="50px">
            </a>
        </div>
        <div class="col s7">
            <h4 class="black-text" style=" padding: 5px;margin-top: 10px;font-size: 25px;">अपना किसान</h4>
        </div>

    </div>
</div>
<script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-firestore.js"></script>

<h6 class="center-align">अपना किसान में आपका स्वागत है</h6>
<h6 class="center-align" id="login-page-text">कृप्या लॉगिन करें</h6>
<div id="firebaseui-container"></div>
<div id="loader">Loading...</div>
<div class="container">
    <div class="row">
        <div class="col s12">
            <div class="loadingio-spinner-ellipsis-qa4kcv0ayff" id="login-page-animation" style="display: none;">
                <div class="ldio-nd7rhqzx4dm">
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style type="text/css">
    @keyframes ldio-nd7rhqzx4dm {
        0% {
            transform: translate(13.79px, 80.77px) scale(0);
        }

        25% {
            transform: translate(13.79px, 80.77px) scale(0);
        }

        50% {
            transform: translate(13.79px, 80.77px) scale(1);
        }

        75% {
            transform: translate(80.77px, 80.77px) scale(1);
        }

        100% {
            transform: translate(147.75px, 80.77px) scale(1);
        }
    }

    @keyframes ldio-nd7rhqzx4dm-r {
        0% {
            transform: translate(147.75px, 80.77px) scale(1);
        }

        100% {
            transform: translate(147.75px, 80.77px) scale(0);
        }
    }

    @keyframes ldio-nd7rhqzx4dm-c {
        0% {
            background: #e15b64
        }

        25% {
            background: #abbd81
        }

        50% {
            background: #f8b26a
        }

        75% {
            background: #f47e60
        }

        100% {
            background: #e15b64
        }
    }

    .ldio-nd7rhqzx4dm div {
        position: absolute;
        width: 35.46px;
        height: 35.46px;
        border-radius: 50%;
        transform: translate(80.77px, 80.77px) scale(1);
        background: #e15b64;
        animation: ldio-nd7rhqzx4dm 3.571428571428571s infinite cubic-bezier(0, 0.5, 0.5, 1);
    }

    .ldio-nd7rhqzx4dm div:nth-child(1) {
        background: #f47e60;
        transform: translate(147.75px, 80.77px) scale(1);
        animation: ldio-nd7rhqzx4dm-r 0.8928571428571428s infinite cubic-bezier(0, 0.5, 0.5, 1), ldio-nd7rhqzx4dm-c 3.571428571428571s infinite step-start;
    }

    .ldio-nd7rhqzx4dm div:nth-child(2) {
        animation-delay: -0.8928571428571428s;
        background: #e15b64;
    }

    .ldio-nd7rhqzx4dm div:nth-child(3) {
        animation-delay: -1.7857142857142856s;
        background: #f47e60;
    }

    .ldio-nd7rhqzx4dm div:nth-child(4) {
        animation-delay: -2.6785714285714284s;
        background: #f8b26a;
    }

    .ldio-nd7rhqzx4dm div:nth-child(5) {
        animation-delay: -3.571428571428571s;
        background: #abbd81;
    }

    .loadingio-spinner-ellipsis-qa4kcv0ayff {
        width: 197px;
        height: 197px;
        display: inline-block;
        overflow: hidden;
        background: #ffffff;
        margin-left: 50px;
    }

    .ldio-nd7rhqzx4dm {
        width: 100%;
        height: 100%;
        position: relative;
        transform: translateZ(0) scale(1);
        backface-visibility: hidden;
        transform-origin: 0 0;
        /* see note above */
    }

    .ldio-nd7rhqzx4dm div {
        box-sizing: content-box;
    }

    /* generated by https://loading.io/ */
</style>

<script>
    var firebaseConfig = {
        apiKey: "AIzaSyBD1Os8BslXS6JfNjicK8l2FbmI9YtEr1w",
        authDomain: "apnakisan-cfe53.firebaseapp.com",
        databaseURL: "https://apnakisan-cfe53.firebaseio.com",
        projectId: "apnakisan-cfe53",
        appId: "1:347167391317:web:d6bec0dc2e9ee522e69edc",
        measurementId: "G-V0GCSJZGX5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Set persistence to none.
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE);
    // Initialize the FirebaseUI Widget using Firebase.
    const ui = new firebaseui.auth.AuthUI(firebase.auth());

    var uiConfig = {
        callbacks: {
            signInSuccessWithAuthResult: function (authResult, redirectUrl) {
                document.getElementById('login-page-text').style.display = "none";
                document.getElementById('login-page-animation').style.display = '';
                handleSignedInUser(authResult?.user);
                // Do not automatically redirect.
                return false;
            },
            uiShown: function () {
                document.getElementById('loader').style.display = 'none';
            }
        },
        // Will use popup for IDP Providers sign-in flow instead of the default, redirect.
        signInFlow: 'popup',
        signInSuccessUrl: '/',
        signInOptions: [
            {
                provider: firebase.auth.PhoneAuthProvider.PROVIDER_ID,
                recaptchaParameters: {
                    size: 'invisible', // 'invisible' or 'compact'
                    badge: 'bottomleft' //' bottomright' or 'inline' applies to invisible.
                },
                defaultCountry: 'IND',
                defaultNationalNumber: '',
                loginHint: '+91'
            }
        ],

        // Terms of service url.
        tosUrl: 'https://www.google.com',
        // Privacy policy url.
        privacyPolicyUrl: '<your-privacy-policy-url>'
    };

    const handleSignedInUser = function (user) {
        console.log(user)
        db.collection('users').doc(user?.uid).set({
            user: user?.uid,
            phoneNumber: user?.phoneNumber
        })
        // Show redirection notice.
        // document.getElementById('redirecting').classList.remove('hidden');
        // Set session cookie
        user.getIdToken().then((idToken) => {
            // Session login endpoint is queried and the session cookie is set.
            // CSRF token should be sent along with request.
            console.log(idToken)
            const csrfToken = getCookie('csrfToken')
            return postIdTokenToSessionLogin('/sessionLogin', idToken, csrfToken)
                .then(() => {
                    // Redirect to profile on success.
                    return window.location.assign('/home');
                }).catch(error => {
                    console.log(error)
                    return window.location.assign('/');
                })
        }).catch(error => {
            return window.location.assign('/');
        });
    };

    const postIdTokenToSessionLogin = function (url, idToken, csrfToken) {
        // POST to session login endpoint.
        console.log('post id token to session login')
        return $.ajax({
            type: 'POST',
            url: url,
            data: { idToken: idToken, csrfToken: csrfToken },
            contentType: 'application/x-www-form-urlencoded'
        });
    };


    function getCookie(name) {
        const v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
        return v ? v[2] : null;
    }
    const initApp = function () {
        // Renders sign-in page using FirebaseUI.
        ui.start('#firebaseui-container', uiConfig);
        document.querySelector('.firebaseui-title').innerText = 'कृपया अपना मोबाइल नंबर डालें'
        document.querySelector('.firebaseui-title').style.textAlign = "center";
    };

    window.addEventListener('load', initApp);
</script>